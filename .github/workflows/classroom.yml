name: GitHub Classroom Workflow

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build Tests Image
        run: |
          docker build -t tests:latest -f ./Dockerfile . --target=tests
          docker save tests:latest > tests.tar

      - name: Build Runtime Image
        run: |
          docker build -t person_api:latest -f ./Dockerfile . --target=runtime
          docker save person_api:latest > person_api.tar

      - name: Upload Tests Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tests-artifact
          path: tests.tar

      - name: Upload API Artifact
        uses: actions/upload-artifact@v4
        with:
          name: person_api-artifact
          path: person_api.tar

  tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Tests Artifact
        uses: actions/download-artifact@v4
        with:
          name: tests-artifact
          path: .

      - name: Load Tests Image
        run: |
          docker load < tests.tar
          echo "Tests image loaded successfully from artifact"

      - name: Run tests with docker compose
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ docker-compose Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ CI
          cat > docker-compose.ci.tests.yml << 'EOF'
          version: '3.8'

          services:
            postgres:
              image: postgres:13
              container_name: persons-db
              environment:
                POSTGRES_USER: program
                POSTGRES_PASSWORD: test
                POSTGRES_DB: persons
              ports:
                - "5433:5432"
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U program -d persons"]
                interval: 5s
                timeout: 3s
                retries: 20
              networks: [app-network]

            tests:
              image: tests:latest
              container_name: persons-tests
              depends_on:
                postgres:
                  condition: service_healthy
              environment:
                TEST_DB_URL: "postgres://program:test@postgres:5432/persons?sslmode=disable"
              networks: [app-network]
              command: go test ./... -v
              restart: "no"

          networks:
            app-network:
              driver: bridge
          EOF

          docker compose -f docker-compose.ci.tests.yml up --abort-on-container-exit --exit-code-from tests

      - name: Cleanup test containers
        if: always()
        run: |
          docker compose -f docker-compose.ci.tests.yml down

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: tests
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² master
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download API Artifact
        uses: actions/download-artifact@v4
        with:
          name: person_api-artifact
          path: .

      - name: Install jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Update Configuration for Render
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVICE_NAME }}.onrender.com"
          echo "Using Render URL: $RENDER_URL"
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ OpenAPI ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
          if [ -f "./person-service.yaml" ]; then
            sed -i "s|http://localhost:8080|$RENDER_URL|g" ./person-service.yaml
            echo "âœ… Updated OpenAPI host to: $RENDER_URL"
          fi
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Postman environment
          ENV_FILE="postman/[inst][heroku] Lab1.postman_environment.json"
          if [ -f "$ENV_FILE" ]; then
            jq --arg url "$RENDER_URL" '(.values[] | select(.key == "baseUrl") | .value) = $url' "$ENV_FILE" > temp.json && mv temp.json "$ENV_FILE"
            echo "âœ… Updated Postman environment with Render URL: $RENDER_URL"
          fi

      - name: Commit Configuration Updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ci: Update configuration for Render deployment [skip ci]" || echo "No changes to commit"

      - name: Push to Trigger Render Auto-Deploy
        run: |
          git push origin master
          echo "ğŸš€ Triggered Render auto-deploy from master branch"

      - name: Wait for Render Deployment
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVICE_NAME }}.onrender.com"
          echo "â³ Waiting for Render to complete deployment..."
          echo "ğŸ“± Application URL: $RENDER_URL"
          
          # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Render (Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒ Ğ´Ğ¾ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
          for i in {1..30}; do
            echo "Attempt $i/30: Checking application health..."
            if curl -s -f "$RENDER_URL/api/v1/persons" > /dev/null; then
              echo "âœ… Render deployment completed successfully!"
              echo "ğŸ‰ Application is now live at: $RENDER_URL"
              break
            else
              if [ $i -eq 30 ]; then
                echo "âŒ Render deployment timed out after 15 minutes"
                echo "ğŸ’¡ Check Render dashboard for deployment status: https://dashboard.render.com"
                exit 1
              fi
              echo "â³ Application not ready yet, waiting 30 seconds..."
              sleep 30
            fi
          done

      - name: Run API Tests against Render
        uses: matt-ball/newman-action@master
        with:
          collection: postman/[inst] Lab1.postman_collection.json
          environment: postman/[inst][heroku] Lab1.postman_environment.json
          delayRequest: 100
          reporters: '[ "cli" ]'

      - name: Deployment Success
        if: success()
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVICE_NAME }}.onrender.com"
          echo "ğŸ‰ Deployment to Render completed successfully!"
          echo "ğŸ“± Application URL: $RENDER_URL"
          echo "ğŸ” API documentation: $RENDER_URL/docs"
          echo "ğŸ‘¤ Health check: $RENDER_URL/api/v1/persons"
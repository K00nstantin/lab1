name: GitHub Classroom Workflow

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build Tests Image
        run: |
          docker build -t tests:latest -f ./Dockerfile . --target=tests
          docker save tests:latest > tests.tar

      - name: Build Runtime Image
        run: |
          docker build -t person_api:latest -f ./Dockerfile . --target=runtime
          docker save person_api:latest > person_api.tar

      - name: Upload Tests Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tests-artifact
          path: tests.tar

      - name: Upload API Artifact
        uses: actions/upload-artifact@v4
        with:
          name: person_api-artifact
          path: person_api.tar

  tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Tests Artifact
        uses: actions/download-artifact@v4
        with:
          name: tests-artifact
          path: .

      - name: Load Tests Image
        run: |
          docker load < tests.tar

      - name: Run tests using existing docker-compose
        run: |
          docker compose up postgres -d
          sleep 3
          docker run --rm --network host -e DATABASE_URL="postgres://program:test@localhost:5433/persons?sslmode=disable" tests:latest

      - name: Cleanup
        if: always()
        run: |
          docker compose down

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: tests
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Validate Render Configuration
        run: |
          if [ -z "${{ secrets.RENDER_SERVICE_NAME }}" ]; then
            echo "ERROR: RENDER_SERVICE_NAME secret is missing or empty"
            exit 1
          fi
          
          RENDER_URL="https://${{ secrets.RENDER_SERVICE_NAME }}.onrender.com"
          echo "Render URL: $RENDER_URL"
          
          # Проверяем что имя сервиса не пустое
          if [ "${{ secrets.RENDER_SERVICE_NAME }}" = "" ]; then
            echo "ERROR: RENDER_SERVICE_NAME is empty"
            exit 1
          fi

      - name: Diagnostic Checks
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVICE_NAME }}.onrender.com"
          
          echo "=== DNS Diagnostic ==="
          nslookup ${{ secrets.RENDER_SERVICE_NAME }}.onrender.com || echo "DNS lookup failed"
          
          echo "=== Network Diagnostic ==="
          ping -c 3 ${{ secrets.RENDER_SERVICE_NAME }}.onrender.com || echo "Ping failed"
          
          echo "=== HTTP Diagnostic ==="
          curl -I --connect-timeout 10 "$RENDER_URL" || echo "HTTP check failed"

      - name: Update Postman Environment
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVICE_NAME }}.onrender.com"
          ENV_FILE="postman/[inst][heroku] Lab1.postman_environment.json"
          
          # Проверяем что файл существует
          if [ ! -f "$ENV_FILE" ]; then
            echo "ERROR: Postman environment file not found: $ENV_FILE"
            ls -la postman/
            exit 1
          fi
          
          # Создаем backup и обновляем
          cp "$ENV_FILE" "${ENV_FILE}.backup"
          sed -i "s|\"value\": \"[^\"]*\"|\"value\": \"$RENDER_URL\"|g" "$ENV_FILE"
          
          # Проверяем что замена произошла
          echo "=== Updated Postman Environment ==="
          grep "value" "$ENV_FILE"

      - name: Wait for Render Deployment
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVICE_NAME }}.onrender.com"
          echo "Waiting for Render deployment: $RENDER_URL"
          
          # Даем больше времени для деплоя Render
          for i in {1..12}; do
            if curl -s -f --max-time 10 "$RENDER_URL/api/v1/persons" > /dev/null; then
              echo "Application is ready"
              exit 0
            else
              echo "Attempt $i/12: Application not ready, waiting 15 seconds..."
              sleep 15
            fi
          done
          
          echo "WARNING: Application might still be deploying"
          echo "Continuing with tests anyway..."

      - name: Run API Tests
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVICE_NAME }}.onrender.com"
          ENV_FILE="postman/[inst][heroku] Lab1.postman_environment.json"
          
          echo "Running tests against: $RENDER_URL"
          npx newman run "postman/[inst] Lab1.postman_collection.json" -e "$ENV_FILE" --delay-request 100
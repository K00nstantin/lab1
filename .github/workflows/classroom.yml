name: GitHub Classroom Workflow

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build Tests Image
        run: |
          docker build -t tests:latest -f ./Dockerfile . --target=tests
          docker save tests:latest > tests.tar

      - name: Build Runtime Image
        run: |
          docker build -t person_api:latest -f ./Dockerfile . --target=runtime
          docker save person_api:latest > person_api.tar

      - name: Upload Tests Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tests-artifact
          path: tests.tar

      - name: Upload API Artifact
        uses: actions/upload-artifact@v4
        with:
          name: person_api-artifact
          path: person_api.tar

  tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Tests Artifact
        uses: actions/download-artifact@v4
        with:
          name: tests-artifact
          path: .

      - name: Load Tests Image
        run: |
          docker load < tests.tar

      - name: Run tests using existing docker-compose
        run: |
          docker compose up postgres -d
          sleep 3
          docker run --rm --network host -e DATABASE_URL="postgres://program:test@localhost:5433/persons?sslmode=disable" tests:latest

      - name: Cleanup
        if: always()
        run: |
          docker compose down

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: tests
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Validate Render Configuration
        run: |
          if [ -z "${{ secrets.RENDER_SERVER_ID }}" ]; then
            echo "ERROR: RENDER_SERVICE_NAME secret is missing"
            echo "Please add RENDER_SERVICE_NAME to GitHub repository secrets:"
            echo "Settings → Secrets and variables → Actions → New repository secret"
            echo "Name: RENDER_SERVICE_NAME"
            echo "Value: your-render-service-name"
            exit 1
          fi
          
          RENDER_URL="https://${{ secrets.RENDER_SERVER_ID }}.onrender.com"
          echo "Using Render URL: $RENDER_URL"

      - name: Update Postman Environment
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVER_ID }}.onrender.com"
          ENV_FILE="postman/[inst][heroku] Lab1.postman_environment.json"
          sed -i "s|\"value\": \"[^\"]*\"|\"value\": \"$RENDER_URL\"|g" "$ENV_FILE"

      - name: Wait for Render Deployment
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVER_ID }}.onrender.com"
          sleep 30
          for i in {1..5}; do
            if curl -s -f --max-time 5 "$RENDER_URL/api/v1/persons" > /dev/null; then
              exit 0
            else
              sleep 10
            fi
          done
          exit 1

      - name: Run API Tests
        run: |
          RENDER_URL="https://${{ secrets.RENDER_SERVER_ID }}.onrender.com"
          ENV_FILE="postman/[inst][heroku] Lab1.postman_environment.json"
          npx newman run "postman/[inst] Lab1.postman_collection.json" -e "$ENV_FILE" --delay-request 100